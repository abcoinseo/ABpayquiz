<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AB Quiz App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//whephiwums.com/sdk.js' data-zone='9303248' data-sdk='show_9303248'></script>
    <style>
        :root {
            --primary-pink: #FF69B4; /* Deep Pink */
            --secondary-pink: #FFB6C1; /* Light Pink */
            --accent-pink: #FF1493; /* Hot Pink for accents */
            --text-color-dark: #4F4F4F; /* Dark grey for text on light backgrounds */
            --text-color-light: #FFFFFF; /* White text for dark backgrounds */
            --background-light: #FFF0F5; /* Lavender Blush - very light pink */
            --border-color: #FFC0CB; /* Pink border */
            --success-color: #32CD32; /* Lime Green */
            --error-color: #FF6347; /* Tomato Red */
            --disabled-color: #D3D3D3; /* Light Grey */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-color-dark);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-container {
            padding: 15px;
            flex-grow: 1;
        }

        header {
            background-color: var(--primary-pink);
            color: var(--text-color-light);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .balance-display {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
            color: var(--text-color-light); /* White text for balance on pink header */
        }

        nav {
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-pink);
            padding: 10px 0;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }

        nav button {
            background-color: transparent;
            color: var(--primary-pink);
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        nav button.active {
            color: var(--accent-pink);
            border-bottom: 2px solid var(--accent-pink);
        }

        nav button:hover {
            color: var(--accent-pink);
        }

        .page {
            display: none; /* Hidden by default */
            padding-bottom: 70px; /* Space for fixed nav */
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--text-color-light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .card h2 {
            color: var(--primary-pink);
            margin-top: 0;
        }

        button.primary-button {
            background-color: var(--primary-pink);
            color: var(--text-color-light);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: block;
            width: 100%;
            margin-top: 15px;
            text-align: center;
        }

        button.primary-button:hover {
            background-color: var(--accent-pink);
            transform: translateY(-2px);
        }
        button.primary-button:active {
            transform: translateY(0px);
        }
        button.primary-button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .quiz-option {
            display: block;
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            background-color: var(--secondary-pink);
            color: var(--text-color-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .quiz-option:hover {
            background-color: var(--primary-pink);
            color: var(--text-color-light);
        }
        
        .quiz-option.selected {
            background-color: var(--accent-pink);
            color: var(--text-color-light);
            font-weight: bold;
        }

        #leaderboard-list li {
            background-color: var(--secondary-pink);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color-dark);
        }
        #leaderboard-list li:nth-child(odd) {
            background-color: #FFE4E1; /* Misty Rose */
        }
        #leaderboard-list .rank {
            font-weight: bold;
            color: var(--primary-pink);
            margin-right: 10px;
        }

        .profile-info p {
            margin: 8px 0;
            font-size: 1.1em;
        }
        .profile-info strong {
            color: var(--primary-pink);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeInModal 0.3s ease;
        }

        .modal-content {
            background-color: var(--background-light);
            margin: 15% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-content h3 {
            color: var(--primary-pink);
            margin-top: 0;
        }

        .close-button {
            color: var(--primary-pink);
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--accent-pink);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        input[type="number"], input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--text-color-light);
            color: var(--text-color-dark);
        }

        #hold-to-withdraw-button {
            position: relative;
            overflow: hidden;
        }
        #hold-progress {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            width: 0%;
            transition: width 0.1s linear;
        }
        .toast {
            position: fixed;
            bottom: 80px; /* Above nav */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-pink);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.5s ease, bottom 0.5s ease;
            font-size: 0.9em;
        }
        .toast.show {
            opacity: 1;
            bottom: 90px;
        }
        .loader {
            border: 5px solid var(--secondary-pink);
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .text-center {
            text-align: center;
        }
        .pink-link {
            color: var(--primary-pink);
            text-decoration: none;
            font-weight: bold;
        }
        .pink-link:hover {
            color: var(--accent-pink);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <h1>AB Quiz</h1>
        <div class="balance-display">Balance: <span id="user-balance">0</span> ৳</div>
    </header>

    <div class="app-container">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <div class="card">
                <h2>Daily Quiz Challenge</h2>
                <div id="quiz-area">
                    <p id="quiz-loading">Loading quiz...</p>
                    <div id="quiz-content" style="display:none;">
                        <p id="quiz-question" style="font-weight:bold; font-size: 1.1em;"></p>
                        <div id="quiz-options"></div>
                        <p>Coins for this quiz: <span id="quiz-coins"></span> ৳</p>
                        <button id="submit-answer-button" class="primary-button">Submit Answer</button>
                    </div>
                    <p id="quiz-limit-message" style="display:none; color: var(--accent-pink); font-weight: bold;"></p>
                </div>
            </div>
             <div class="card">
                <h2>Earn Extra BDT</h2>
                <p>Watch an ad to earn 0.1 ৳</p>
                <button id="watch-ad-button" class="primary-button" style="background-color: var(--success-color);">Watch Ad & Earn</button>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard-page" class="page">
            <div class="card">
                <h2>Leaderboard</h2>
                <div id="leaderboard-loading" class="loader"></div>
                <ul id="leaderboard-list" style="list-style-type: none; padding: 0;">
                    <!-- Leaderboard items will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page">
            <div class="card">
                <h2>My Profile</h2>
                <div class="profile-info">
                    <p><strong>Name:</strong> <span id="profile-name">-</span></p>
                    <p><strong>User ID:</strong> <span id="profile-id">-</span></p>
                    <p><strong>Current Balance:</strong> <span id="profile-balance">0</span> ৳</p>
                    <p><strong>Quizzes Today:</strong> <span id="profile-quizzes-today">0</span>/10</p>
                </div>
                <button id="withdraw-button" class="primary-button">Withdraw Balance</button>
            </div>
            <div class="card">
                <h2>Wallet & Community</h2>
                <p>Manage your withdrawals: <a href="https://t.me/ABpaybdbot" target="_blank" class="pink-link" id="wallet-link">ABPayBD Bot Wallet</a></p>
                <p>
                    <a href="https://t.me/Abpaybd" target="_blank" class="primary-button" style="text-decoration: none;">Join Our Community</a>
                </p>
            </div>
        </div>
    </div>

    <nav>
        <button id="nav-home" class="active" onclick="showPage('home-page')">Home</button>
        <button id="nav-leaderboard" onclick="showPage('leaderboard-page')">Leaderboard</button>
        <button id="nav-profile" onclick="showPage('profile-page')">Profile</button>
    </nav>

    <!-- Withdrawal Modal -->
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('withdraw-modal')">×</span>
            <h3>Withdraw Funds</h3>
            <p>Your current balance: <span id="modal-current-balance">0</span> ৳</p>
            <label for="withdraw-amount">Amount to withdraw (BDT):</label>
            <input type="number" id="withdraw-amount" placeholder="Enter amount">
            <button onclick="document.getElementById('withdraw-amount').value = currentUser.balance.toFixed(2)" class="primary-button" style="background-color: var(--secondary-pink); color: var(--primary-pink); margin-bottom: 10px;">Use Max Amount</button>
            <p style="font-size:0.8em; color: var(--text-color-dark);">Min withdrawal: 10 ৳. Max: 5000 ৳.</p>
            <button id="hold-to-withdraw-button" class="primary-button">
                <span id="hold-text">Press & Hold to Confirm (2s)</span>
                <div id="hold-progress"></div>
            </button>
            <p id="withdraw-message" style="margin-top:10px; text-align:center;"></p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <!-- Firebase SDKs -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB-orRfGPS3vUlPAYkh-BYRE-3AbcyO1LQ",
            authDomain: "ab-quiz-f3f31.firebaseapp.com",
            projectId: "ab-quiz-f3f31",
            storageBucket: "ab-quiz-f3f31.firebasestorage.app",
            messagingSenderId: "79725714366",
            appId: "1:79725714366:web:067b985b568052c8e277ef"
        };

        // Global variables
        let tgUser = null;
        let currentUser = null;
        let currentQuiz = null;
        let selectedOption = null;
        let db = null;
        const DAILY_QUIZ_LIMIT = 10;
        const MIN_WITHDRAWAL = 10;
        const MAX_WITHDRAWAL = 5000;

        // Hold to withdraw variables
        let holdTimeout;
        let holdStartTime;
        const HOLD_DURATION = 2000; // 2 seconds

        // DOM Elements
        const userBalanceDisplay = document.getElementById('user-balance');
        const quizArea = document.getElementById('quiz-area');
        const quizLoading = document.getElementById('quiz-loading');
        const quizContent = document.getElementById('quiz-content');
        const quizQuestionElem = document.getElementById('quiz-question');
        const quizOptionsElem = document.getElementById('quiz-options');
        const quizCoinsElem = document.getElementById('quiz-coins');
        const submitAnswerButton = document.getElementById('submit-answer-button');
        const quizLimitMessage = document.getElementById('quiz-limit-message');
        
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardLoading = document.getElementById('leaderboard-loading');

        const profileName = document.getElementById('profile-name');
        const profileId = document.getElementById('profile-id');
        const profileBalance = document.getElementById('profile-balance');
        const profileQuizzesToday = document.getElementById('profile-quizzes-today');

        const withdrawModal = document.getElementById('withdraw-modal');
        const modalCurrentBalance = document.getElementById('modal-current-balance');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const holdToWithdrawButton = document.getElementById('hold-to-withdraw-button');
        const holdProgress = document.getElementById('hold-progress');
        const holdText = document.getElementById('hold-text');
        const withdrawMessage = document.getElementById('withdraw-message');
        
        const watchAdButton = document.getElementById('watch-ad-button');

        // Toast Notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            if (pageId === 'home-page') document.getElementById('nav-home').classList.add('active');
            if (pageId === 'leaderboard-page') {
                 document.getElementById('nav-leaderboard').classList.add('active');
                 loadLeaderboard();
            }
            if (pageId === 'profile-page') {
                document.getElementById('nav-profile').classList.add('active');
                updateProfilePage();
            }
        }

        // Modal Control
        function openModal(modalId) {
            if (modalId === 'withdraw-modal') {
                modalCurrentBalance.textContent = currentUser.balance.toFixed(2);
                withdrawAmountInput.value = '';
                withdrawMessage.textContent = '';
                holdProgress.style.width = '0%';
                holdText.textContent = 'Press & Hold to Confirm (2s)';
                holdToWithdrawButton.disabled = false;
            }
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (holdTimeout) clearTimeout(holdTimeout); // Clear hold timer if modal is closed
            holdProgress.style.width = '0%';
        }

        // Firebase Helper Functions
        async function readData(path) {
            try {
                const snapshot = await db.ref(path).once('value');
                return snapshot.val();
            } catch (error) {
                console.error("Firebase read error:", error);
                showToast("Error reading data.", 3000);
                return null;
            }
        }

        async function writeData(path, data) {
            try {
                await db.ref(path).set(data);
            } catch (error) {
                console.error("Firebase write error:", error);
                showToast("Error writing data.", 3000);
            }
        }
        async function updateData(path, data) {
            try {
                await db.ref(path).update(data);
            } catch (error) {
                console.error("Firebase update error:", error);
                showToast("Error updating data.", 3000);
            }
        }
        async function pushData(path, data) {
             try {
                const newRef = db.ref(path).push();
                await newRef.set(data);
                return newRef.key;
            } catch (error) {
                console.error("Firebase push error:", error);
                showToast("Error saving data.", 3000);
                return null;
            }
        }

        // User Initialization
        async function initializeUser() {
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            if (!tgUser || !tgUser.id) {
                quizArea.innerHTML = "<p>Could not verify Telegram user. Please try again.</p>";
                console.error("Telegram user data not available.");
                Telegram.WebApp.close();
                return;
            }

            const userId = String(tgUser.id); // Ensure ID is string for Firebase path
            currentUser = await readData(`users/${userId}`);

            const today = new Date().toISOString().split('T')[0];

            if (!currentUser) {
                currentUser = {
                    id: userId,
                    username: tgUser.username || 'N/A',
                    firstName: tgUser.first_name || 'User',
                    balance: 0,
                    lastQuizDate: today,
                    quizzesTakenToday: 0,
                    totalScore: 0 // Could be sum of coins earned or separate score
                };
                await writeData(`users/${userId}`, currentUser);
                showToast(`Welcome, ${currentUser.firstName}!`, 3000);
            } else {
                if (currentUser.lastQuizDate !== today) {
                    currentUser.quizzesTakenToday = 0;
                    currentUser.lastQuizDate = today;
                    await updateData(`users/${userId}`, { 
                        quizzesTakenToday: 0, 
                        lastQuizDate: today 
                    });
                }
            }
            updateBalanceDisplay();
            loadQuiz();
        }

        function updateBalanceDisplay() {
            if (currentUser) {
                const balanceText = currentUser.balance.toFixed(2);
                userBalanceDisplay.textContent = balanceText;
                if(document.getElementById('profile-balance')) { // Check if profile page elements exist
                    profileBalance.textContent = balanceText;
                }
            }
        }
        
        // Quiz Logic
        async function loadQuiz() {
            quizLoading.style.display = 'block';
            quizContent.style.display = 'none';
            quizLimitMessage.style.display = 'none';
            submitAnswerButton.disabled = true;

            if (!currentUser) { // Wait for user to initialize
                setTimeout(loadQuiz, 500); 
                return;
            }
            
            if (currentUser.quizzesTakenToday >= DAILY_QUIZ_LIMIT) {
                quizLoading.style.display = 'none';
                quizLimitMessage.textContent = "You've completed all quizzes for today! Come back tomorrow.";
                quizLimitMessage.style.display = 'block';
                quizContent.style.display = 'none'; // Hide quiz content if limit reached
                return;
            }

            const quizzes = await readData('quizzes');
            if (!quizzes) {
                quizLoading.style.display = 'none';
                quizArea.innerHTML = "<p>No quizzes available at the moment. Please check back later.</p>";
                return;
            }

            const quizIds = Object.keys(quizzes);
            // Simple logic: pick a random quiz. For more complex logic, track completed quizzes.
            // For now, let's pick one that user hasn't done today (not implemented yet, so random)
            const randomQuizId = quizIds[Math.floor(Math.random() * quizIds.length)];
            currentQuiz = quizzes[randomQuizId];
            currentQuiz.id = randomQuizId; // Store ID for reference

            if (!currentQuiz) {
                 quizLoading.style.display = 'none';
                 quizArea.innerHTML = "<p>Failed to load a quiz. Try refreshing.</p>";
                 return;
            }

            quizQuestionElem.textContent = currentQuiz.question;
            quizCoinsElem.textContent = currentQuiz.coins;
            quizOptionsElem.innerHTML = '';
            selectedOption = null;

            currentQuiz.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('quiz-option');
                button.textContent = option;
                button.onclick = () => selectOption(button, option);
                quizOptionsElem.appendChild(button);
            });
            
            quizLoading.style.display = 'none';
            quizContent.style.display = 'block';
            submitAnswerButton.disabled = false;
        }

        function selectOption(buttonElem, optionValue) {
            document.querySelectorAll('.quiz-option').forEach(btn => btn.classList.remove('selected'));
            buttonElem.classList.add('selected');
            selectedOption = optionValue;
        }

        submitAnswerButton.onclick = async () => {
            if (!selectedOption) {
                showToast("Please select an answer.", 2000);
                return;
            }

            submitAnswerButton.disabled = true;
            let earnedCoins = 0;
            if (selectedOption === currentQuiz.answer) {
                earnedCoins = currentQuiz.coins;
                currentUser.balance += earnedCoins;
                currentUser.totalScore += earnedCoins; // Assuming score is sum of coins
                showToast(`Correct! You earned ${earnedCoins} ৳.`, 3000);
            } else {
                showToast(`Incorrect. The correct answer was: ${currentQuiz.answer}`, 3000);
            }

            currentUser.quizzesTakenToday += 1;
            await updateData(`users/${currentUser.id}`, {
                balance: currentUser.balance,
                totalScore: currentUser.totalScore,
                quizzesTakenToday: currentUser.quizzesTakenToday,
                lastQuizDate: currentUser.lastQuizDate // ensure it's today
            });

            updateBalanceDisplay();
            updateProfilePage(); // Update quizzes today on profile if visible
            loadQuiz(); // Load next quiz or show limit message
        };
        
        // Leaderboard Logic
        async function loadLeaderboard() {
            leaderboardLoading.style.display = 'block';
            leaderboardList.innerHTML = '';
            const usersData = await readData('users');
            if (usersData) {
                const usersArray = Object.values(usersData);
                // Sort by balance (descending), then by name (ascending) for ties
                usersArray.sort((a, b) => {
                    if (b.balance === a.balance) {
                        return (a.firstName || '').localeCompare(b.firstName || '');
                    }
                    return b.balance - a.balance;
                });

                usersArray.slice(0, 50).forEach((user, index) => { // Show top 50
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div><span class="rank">#${index + 1}</span> ${user.firstName} (${user.username || 'anonymous'})</div>
                        <span style="font-weight: bold; color: var(--accent-pink);">${user.balance.toFixed(2)} ৳</span>
                    `;
                    leaderboardList.appendChild(li);
                });
            } else {
                leaderboardList.innerHTML = '<li>No data available for leaderboard.</li>';
            }
            leaderboardLoading.style.display = 'none';
        }

        // Profile Page Logic
        function updateProfilePage() {
            if (currentUser && document.getElementById('profile-page').classList.contains('active')) {
                profileName.textContent = `${currentUser.firstName} ${tgUser.last_name || ''}`;
                profileId.textContent = currentUser.id;
                profileBalance.textContent = currentUser.balance.toFixed(2);
                profileQuizzesToday.textContent = `${currentUser.quizzesTakenToday}/${DAILY_QUIZ_LIMIT}`;
            }
        }

        document.getElementById('withdraw-button').onclick = () => {
            if (currentUser) {
                openModal('withdraw-modal');
            } else {
                showToast("User data not loaded yet.", 2000);
            }
        };

        // Hold to withdraw logic
        holdToWithdrawButton.addEventListener('mousedown', startHold);
        holdToWithdrawButton.addEventListener('mouseup', cancelHold);
        holdToWithdrawButton.addEventListener('mouseleave', cancelHold);
        holdToWithdrawButton.addEventListener('touchstart', (e) => { e.preventDefault(); startHold(); }, { passive: false });
        holdToWithdrawButton.addEventListener('touchend', cancelHold);
        holdToWithdrawButton.addEventListener('touchcancel', cancelHold);

        function startHold() {
            if (holdToWithdrawButton.disabled) return;
            holdStartTime = Date.now();
            holdProgress.style.transition = `width ${HOLD_DURATION / 1000}s linear`;
            holdProgress.style.width = '100%';
            holdText.textContent = 'Confirming...';

            holdTimeout = setTimeout(async () => {
                const amount = parseFloat(withdrawAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    withdrawMessage.textContent = "Please enter a valid amount.";
                    withdrawMessage.style.color = 'var(--error-color)';
                    resetHoldButton();
                    return;
                }
                if (amount < MIN_WITHDRAWAL) {
                    withdrawMessage.textContent = `Minimum withdrawal is ${MIN_WITHDRAWAL} ৳.`;
                    withdrawMessage.style.color = 'var(--error-color)';
                    resetHoldButton();
                    return;
                }
                if (amount > MAX_WITHDRAWAL) {
                    withdrawMessage.textContent = `Maximum withdrawal is ${MAX_WITHDRAWAL} ৳.`;
                    withdrawMessage.style.color = 'var(--error-color)';
                    resetHoldButton();
                    return;
                }
                if (amount > currentUser.balance) {
                    withdrawMessage.textContent = "Insufficient balance.";
                    withdrawMessage.style.color = 'var(--error-color)';
                    resetHoldButton();
                    return;
                }

                // Process withdrawal
                holdToWithdrawButton.disabled = true;
                holdText.textContent = 'Processing...';

                const withdrawalData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                const withdrawalId = await pushData('withdrawals', withdrawalData);

                if (withdrawalId) {
                    currentUser.balance -= amount;
                    await updateData(`users/${currentUser.id}`, { balance: currentUser.balance });
                    
                    updateBalanceDisplay();
                    updateProfilePage();
                    
                    withdrawMessage.textContent = `Withdrawal request for ${amount.toFixed(2)} ৳ submitted successfully!`;
                    withdrawMessage.style.color = 'var(--success-color)';
                    showToast("Withdrawal request submitted!", 3000);
                    
                    // Optional: Close modal after a delay or change content
                    setTimeout(() => {
                        closeModal('withdraw-modal');
                        // Potentially update UI related to "wallet link after withdrawal"
                    }, 2000);

                } else {
                    withdrawMessage.textContent = "Failed to submit withdrawal. Please try again.";
                    withdrawMessage.style.color = 'var(--error-color)';
                    resetHoldButton();
                    holdToWithdrawButton.disabled = false;
                }

            }, HOLD_DURATION);
        }
        
        function cancelHold() {
            clearTimeout(holdTimeout);
            if (Date.now() - holdStartTime < HOLD_DURATION) { // Not held long enough
                 resetHoldButton();
            }
        }

        function resetHoldButton() {
            holdProgress.style.transition = 'width 0.1s linear'; // Fast reset
            holdProgress.style.width = '0%';
            holdText.textContent = 'Press & Hold to Confirm (2s)';
        }

        // Ad Logic
        watchAdButton.onclick = () => {
            watchAdButton.disabled = true;
            watchAdButton.textContent = 'Loading Ad...';

            if (typeof show_9303248 === 'function') {
                 show_9303248().then(async () => {
                    showToast('Ad watched! You earned 0.1 ৳.', 3000);
                    currentUser.balance += 0.1;
                    await updateData(`users/${currentUser.id}`, { balance: currentUser.balance });
                    updateBalanceDisplay();
                    updateProfilePage();
                    watchAdButton.disabled = false;
                    watchAdButton.textContent = 'Watch Ad & Earn';
                }).catch(error => {
                    console.error("Ad SDK error:", error);
                    showToast('Ad not available or error. Try again later.', 3000);
                    watchAdButton.disabled = false;
                    watchAdButton.textContent = 'Watch Ad & Earn';
                });
            } else {
                showToast('Ad SDK not loaded. Cannot show ad.', 3000);
                console.error("Ad function show_9303248 not defined.");
                watchAdButton.disabled = false;
                watchAdButton.textContent = 'Watch Ad & Earn';
                // For testing without real ad SDK:
                // (async () => {
                //     showToast('Ad watched! You earned 0.1 ৳.', 3000);
                //     currentUser.balance += 0.1;
                //     await updateData(`users/${currentUser.id}`, { balance: currentUser.balance });
                //     updateBalanceDisplay();
                //     updateProfilePage();
                //     watchAdButton.disabled = false;
                //     watchAdButton.textContent = 'Watch Ad & Earn';
                // })();
            }
        };


        // Initialize App
        window.onload = () => {
            // Initialize Firebase
            if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                } catch (e) {
                    console.error("Firebase initialization error:", e);
                    document.body.innerHTML = "Error initializing application. Please contact support.";
                    return;
                }
            } else {
                 console.error("Firebase SDK not loaded.");
                 document.body.innerHTML = "Critical error: Firebase SDK failed to load. App cannot start.";
                 return;
            }


            Telegram.WebApp.ready();
            Telegram.WebApp.expand(); // Make the web app full height

            // Set background color from Telegram theme if available (optional, user asked for pink)
            // document.body.style.backgroundColor = Telegram.WebApp.themeParams.bg_color || '#FFF0F5';
            // Forcing pink as requested
            document.body.style.backgroundColor = 'var(--background-light)';


            if (db) { // Ensure db is initialized before proceeding
                 initializeUser();
            } else {
                console.error("Database not initialized. User initialization skipped.");
                // Display an error message to the user.
                quizArea.innerHTML = "<p>Application critical error. Database connection failed.</p>";
            }

            // Close modal if clicked outside content
            window.onclick = function(event) {
                if (event.target == withdrawModal) {
                    closeModal('withdraw-modal');
                }
            }
        };

        // Sample Data for Firebase (for testing if database is empty)
        // You would add this directly to your Firebase console
        /*
        Firebase Realtime Database Structure:

        /quizzes
          /quiz1
            question: "What color is the Telegram logo?"
            options: ["Blue", "Green", "Pink", "Red"]
            answer: "Blue"
            coins: 10
          /quiz2
            question: "What is 2 + 2 * 2?"
            options: ["4", "6", "8", "2"]
            answer: "6"
            coins: 5
          /quiz3
            question: "Which planet is known as the Red Planet?"
            options: ["Earth", "Mars", "Jupiter", "Venus"]
            answer: "Mars"
            coins: 8
        
        /users
          / (user data will be populated here by the app)

        /withdrawals
          / (withdrawal requests will be populated here by the app)
        */

    </script>
</body>
</html>
