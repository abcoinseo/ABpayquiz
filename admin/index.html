<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB Quiz Admin Panel Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- PREVIOUS CSS STYLES --- */
        /* (Keep all the CSS from the previous admin panel response) */
        /* Additional styles for new elements if needed */
        :root {
            --admin-primary: #2A3F54; /* Sidebar, dark elements */
            --admin-secondary: #1ABB9C; /* Accent, success */
            --admin-light: #F7F7F7;   /* Main background */
            --admin-dark-text: #5A738E;
            --admin-light-text: #ECF0F1;
            --admin-border: #E6E9ED;
            --admin-hover: #34495E;
            --admin-danger: #d9534f;
            --admin-warning: #f0ad4e;
            --admin-info: #5bc0de;
        }

        body {
            font-family: "Helvetica Neue", Roboto, Arial, sans-serif;
            margin: 0;
            background-color: var(--admin-light);
            color: var(--admin-dark-text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .admin-app-container {
            display: flex;
            width: 100%;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 250px;
            background-color: var(--admin-primary);
            color: var(--admin-light-text);
            padding-top: 15px;
            transition: width 0.3s ease;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
        }
        .admin-sidebar-header {
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .admin-sidebar-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--admin-light-text);
        }
        .admin-sidebar-header h2 i {
            margin-right: 10px;
        }
        .admin-sidebar nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .admin-sidebar nav li a {
            display: block;
            padding: 15px 20px;
            color: var(--admin-light-text);
            text-decoration: none;
            transition: background-color 0.2s ease, padding-left 0.2s ease;
            font-size: 0.95em;
        }
        .admin-sidebar nav li a i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        .admin-sidebar nav li a:hover,
        .admin-sidebar nav li a.active {
            background-color: var(--admin-hover);
            padding-left: 25px;
            border-left: 3px solid var(--admin-secondary);
        }

        /* Main Content Area */
        .admin-main-content {
            flex-grow: 1;
            margin-left: 250px; /* Same as sidebar width */
            padding: 0;
            transition: margin-left 0.3s ease;
        }
        
        /* Top Bar */
        .admin-topbar {
            background-color: #EDEDED; /* Lighter than main bg */
            padding: 10px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--admin-border);
        }
        .admin-topbar .toggle-sidebar {
            font-size: 1.5em;
            cursor: pointer;
            color: var(--admin-primary);
        }
         .admin-topbar h3 {
            margin: 0;
            font-size: 1.3em;
            color: var(--admin-primary);
        }

        .admin-page {
            display: none;
            padding: 20px;
        }
        .admin-page.active {
            display: block;
            animation: fadeInPage 0.5s ease-in-out;
        }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Tiles */
        .dashboard-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .tile {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--admin-border);
            text-align: center;
        }
        .tile h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: var(--admin-dark-text);
            font-size: 1em;
            text-transform: uppercase;
            font-weight: 600;
        }
        .tile .count {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--admin-primary);
            margin-bottom: 10px;
        }
        .tile .icon {
            font-size: 2.5em;
            color: var(--admin-secondary);
            margin-bottom: 10px;
            display: block;
        }
        .tile-green .count { color: var(--admin-secondary); }
        .tile-blue .count { color: var(--admin-info); }
        .tile-orange .count { color: var(--admin-warning); }
        .tile-red .count { color: var(--admin-danger); }


        /* Cards for content sections */
        .content-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--admin-border);
            margin-bottom: 20px;
        }
        .content-card h3 {
            margin-top: 0;
            color: var(--admin-primary);
            border-bottom: 1px solid var(--admin-border);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        .content-card h3 i {
            margin-right: 8px;
        }

        /* Forms */
        .admin-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--admin-dark-text);
        }
        .admin-form input[type="text"],
        .admin-form input[type="number"],
        .admin-form input[type="email"], /* For user email */
        .admin-form textarea,
        .admin-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--admin-border);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.95em;
        }
        .admin-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        .admin-form .form-group {
            margin-bottom: 15px;
        }
        .admin-form .options-group .option-input-group { /* Updated for quiz options */
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .admin-form .options-group .option-input-group input[type="text"]{
             flex-grow: 1;
             margin-bottom: 0; /* remove default margin */
             margin-right: 10px;
        }
         .admin-form .options-group .option-input-group input[type="radio"]{
             margin-right: 5px;
        }
        .admin-form .options-group .remove-option-btn {
            margin-left: 10px;
            color: var(--admin-danger);
            cursor: pointer;
            font-size: 1.1em;
        }


        /* Tables */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .admin-table th, .admin-table td {
            border: 1px solid var(--admin-border);
            padding: 10px 12px;
            text-align: left;
            font-size: 0.9em;
            vertical-align: middle;
        }
        .admin-table thead th {
            background-color: #F5F7FA;
            color: var(--admin-primary);
            font-weight: 600;
        }
        .admin-table tbody tr:nth-child(even) {
            background-color: #FCFDFE;
        }
        .admin-table tbody tr:hover {
            background-color: #F0F3F6;
        }
        .admin-table .action-buttons button, .admin-table .action-buttons a {
            margin-right: 5px;
            padding: 5px 8px;
            font-size: 0.85em;
            text-decoration: none;
        }
        .status-pending { color: var(--admin-warning); font-weight: bold; }
        .status-completed { color: var(--admin-secondary); font-weight: bold; }
        .status-rejected { color: var(--admin-danger); font-weight: bold; }

        /* Buttons */
        .admin-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .admin-button-primary {
            background-color: var(--admin-secondary);
            color: white;
        }
        .admin-button-primary:hover {
            background-color: #169A81;
        }
        .admin-button-danger {
            background-color: var(--admin-danger);
            color: white;
        }
        .admin-button-danger:hover {
            background-color: #c9302c;
        }
        .admin-button-warning {
            background-color: var(--admin-warning);
            color: white;
        }
        .admin-button-warning:hover {
            background-color: #ec971f;
        }
        .admin-button-info {
            background-color: var(--admin-info);
            color: white;
        }
        .admin-button-info:hover {
            background-color: #31b0d5;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 0; /* Collapsed by default */
                overflow: hidden;
            }
            .admin-sidebar.open {
                width: 250px;
            }
            .admin-main-content {
                margin-left: 0;
            }
             .admin-main-content.sidebar-open {
                margin-left: 250px; /* Push content when sidebar explicitly opened */
            }
            .dashboard-tiles {
                grid-template-columns: 1fr; /* Stack tiles */
            }
            .admin-topbar h3 {
                display: none; /* Hide title on small screens to save space */
            }
        }
        .loader {
            border: 5px solid var(--admin-light);
            border-top: 5px solid var(--admin-secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--admin-primary);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateY(-30px);
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-notification.success { background-color: var(--admin-secondary); }
        .toast-notification.error { background-color: var(--admin-danger); }
        .toast-notification.warning { background-color: var(--admin-warning); }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--admin-border);
            border-radius: 5px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid var(--admin-border);
            margin-bottom: 15px;
        }
        .modal-header h4 {
            margin: 0;
            color: var(--admin-primary);
        }
        .close-modal-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal-btn:hover, .close-modal-btn:focus {
            color: black;
            text-decoration: none;
        }
        .table-responsive { overflow-x: auto; }

    </style>
</head>
<body>
    <div class="admin-app-container">
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <h2><i class="fas fa-user-shield"></i> Admin Pro</h2>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="admin-nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" class="admin-nav-link" data-page="manage-quizzes"><i class="fas fa-list-alt"></i> Manage Quizzes</a></li>
                    <li><a href="#" class="admin-nav-link" data-page="add-quiz"><i class="fas fa-plus-circle"></i> Add New Quiz</a></li>
                    <li><a href="#" class="admin-nav-link" data-page="manage-users"><i class="fas fa-users-cog"></i> Manage Users</a></li>
                    <li><a href="#" class="admin-nav-link" data-page="manage-withdrawals"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a></li>
                    <li><a href="#" class="admin-nav-link" data-page="reports"><i class="fas fa-chart-pie"></i> Reports</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main-content" id="adminMainContent">
            <div class="admin-topbar">
                <span class="toggle-sidebar" id="toggleSidebarBtn"><i class="fas fa-bars"></i></span>
                <h3 id="currentPageTitle">Dashboard</h3>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard" class="admin-page active">
                <div class="dashboard-tiles">
                    <!-- Tiles from previous version -->
                    <div class="tile tile-blue">
                        <i class="fas fa-users icon"></i>
                        <h4>Total Users</h4>
                        <div class="count" id="totalUsersCount">0</div>
                    </div>
                    <div class="tile tile-green">
                        <i class="fas fa-wallet icon"></i>
                        <h4>Total App Earn (Quiz)</h4>
                        <div class="count" id="totalAppEarnCount">0 ৳</div>
                    </div>
                    <div class="tile tile-orange">
                         <i class="fas fa-hourglass-half icon"></i>
                        <h4>Pending Withdrawals</h4>
                        <div class="count" id="pendingWithdrawalsCount">0</div>
                    </div>
                    <div class="tile tile-green">
                         <i class="fas fa-check-circle icon"></i>
                        <h4>Completed Withdrawals</h4>
                        <div class="count" id="completedWithdrawalsCount">0</div>
                    </div>
                     <div class="tile tile-info">
                        <i class="fas fa-ad icon"></i>
                        <h4>Total Ads Shown</h4>
                        <div class="count" id="totalAdsCount">0</div>
                    </div>
                    <div class="tile tile-green">
                        <i class="fas fa-money-bill-wave icon"></i>
                        <h4>Admin Ad Earnings</h4>
                        <div class="count" id="adminAdEarningsCount">0.00 ৳</div>
                    </div>
                </div>
                <div class="content-card">
                    <h3><i class="fas fa-chart-line"></i> User Registrations & Activity (Mock)</h3>
                    <canvas id="userActivityChart" height="120"></canvas>
                </div>
                 <div class="content-card">
                    <h3><i class="fas fa-hand-holding-usd"></i> Recent Withdrawals</h3>
                     <div class="table-responsive">
                        <table class="admin-table">
                            <thead><tr><th>Date</th><th>User</th><th>Amount</th><th>Status</th></tr></thead>
                            <tbody id="recentWithdrawalsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Quizzes Page -->
            <div id="manage-quizzes" class="admin-page">
                <div class="content-card">
                    <h3><i class="fas fa-edit"></i> Manage Existing Quizzes</h3>
                    <div id="quizzesLoader" class="loader" style="display:none;"></div>
                     <div class="table-responsive">
                        <table class="admin-table" id="quizzesTable">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Coins</th>
                                    <th>Options</th>
                                    <th>Answer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Quiz Page (Form will be reused) -->
            <div id="add-quiz" class="admin-page">
                <div class="content-card">
                    <h3 id="quizFormTitle"><i class="fas fa-feather-alt"></i> Create New Quiz</h3>
                    <form id="quizForm" class="admin-form">
                        <input type="hidden" id="editQuizId">
                        <div class="form-group">
                            <label for="quizQuestion">Question:</label>
                            <textarea id="quizQuestion" required></textarea>
                        </div>
                        <div class="form-group options-group">
                            <label>Options (Mark the correct one radio button):</label>
                            <div id="quizOptionsContainer">
                                <!-- Options will be added by JS -->
                            </div>
                            <button type="button" id="addOptionBtn" class="admin-button admin-button-info" style="margin-top:5px; font-size:0.8em; padding: 8px 12px;"><i class="fas fa-plus"></i> Add Option</button>
                        </div>
                        <div class="form-group">
                            <label for="quizCoins">Coins (0.001 to 100):</label>
                            <input type="number" id="quizCoins" step="0.001" min="0.001" max="100" value="5" required>
                        </div>
                        <button type="submit" class="admin-button admin-button-primary"><i class="fas fa-save"></i> Save Quiz</button>
                        <button type="button" id="cancelEditQuizBtn" class="admin-button" style="background-color: #777; color:white; display:none;"><i class="fas fa-times"></i> Cancel Edit</button>
                    </form>
                </div>
            </div>

            <!-- Manage Users Page -->
            <div id="manage-users" class="admin-page">
                <div class="content-card">
                    <h3><i class="fas fa-users-cog"></i> User Management</h3>
                    <div id="usersLoader" class="loader" style="display:none;"></div>
                    <input type="text" id="userSearchInput" placeholder="Search by User ID or Username..." style="margin-bottom: 15px; padding:10px; width: calc(100% - 22px); border:1px solid var(--admin-border);">
                    <div class="table-responsive">
                        <table class="admin-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>First Name</th>
                                    <th>Balance (৳)</th>
                                    <th>Quizzes Today</th>
                                    <th>Ads Today</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Withdrawals Page -->
            <div id="manage-withdrawals" class="admin-page">
                <!-- Same as previous -->
                <div class="content-card">
                    <h3><i class="fas fa-tasks"></i> Withdrawal Requests</h3>
                    <div id="withdrawalsLoader" class="loader" style="display:none;"></div>
                    <div class="table-responsive">
                        <table class="admin-table" id="withdrawalsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>Amount (৳)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="admin-page">
                <!-- Same as previous, ensure chart IDs are unique if needed -->
                 <div class="content-card">
                    <h3><i class="fas fa-file-download"></i> Generate Reports</h3>
                    <p>Client-side PDF generation for large datasets can be slow. This provides basic table exports.</p>
                    <button id="downloadUsersPdf" class="admin-button admin-button-primary"><i class="fas fa-users"></i> Download Users Report (PDF)</button>
                    <button id="downloadWithdrawalsPdf" class="admin-button admin-button-primary" style="margin-left:10px;"><i class="fas fa-money-check-alt"></i> Download Withdrawals Report (PDF)</button>
                    <div style="margin-top: 20px;">
                        <h4>Withdrawal Status Overview</h4>
                        <canvas id="withdrawalStatusChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- User Edit Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Edit User Details</h4>
                <span class="close-modal-btn" onclick="closeModal('editUserModal')">×</span>
            </div>
            <form id="editUserForm" class="admin-form">
                <input type="hidden" id="editingUserId">
                <div class="form-group">
                    <label for="editUserUsername">Username:</label>
                    <input type="text" id="editUserUsername" required>
                </div>
                <div class="form-group">
                    <label for="editUserFirstName">First Name:</label>
                    <input type="text" id="editUserFirstName" required>
                </div>
                <div class="form-group">
                    <label for="editUserBalance">Balance (৳):</label>
                    <input type="number" step="0.01" id="editUserBalance" required>
                </div>
                <div class="form-group">
                    <label for="editUserQuizzesToday">Quizzes Today:</label>
                    <input type="number" id="editUserQuizzesToday" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editUserAdsToday">Ads Watched Today:</label>
                    <input type="number" id="editUserAdsToday" min="0" required>
                </div>
                <!-- Add more fields as needed, e.g., totalAdsWatched -->
                <button type="submit" class="admin-button admin-button-primary"><i class="fas fa-save"></i> Save Changes</button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast-notification"></div>

    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
                // Primary Firebase Config (Quiz App)
                const firebaseConfigPrimary = {
            apiKey: "AIzaSyB-orRfGPS3vUlPAYkh-BYRE-3AbcyO1LQ", // YOUR QUIZ APP API KEY
            authDomain: "ab-quiz-f3f31.firebaseapp.com",
            projectId: "ab-quiz-f3f31",
            storageBucket: "ab-quiz-f3f31.firebasestorage.app",
            messagingSenderId: "79725714366",
            appId: "1:79725714366:web:067b985b568052c8e277ef"
        };

        // Secondary Firebase Config (AB Pay - for withdrawal payouts)
        const firebaseConfigSecondary = {
            apiKey: "AIzaSyDSTwy1mTUhfvLCFH_npUWC3MPS13tMQbs", // YOUR AB PAY API KEY
            authDomain: "ab-pay-17484.firebaseapp.com",
            databaseURL: "https://ab-pay-17484-default-rtdb.firebaseio.com",
            projectId: "ab-pay-17484",
            storageBucket: "ab-pay-17484.firebasestorage.app",
            messagingSenderId: "523466800109",
            appId: "1:523466800109:web:4b9b8766ff6e07631305e4"
        };

        let primaryApp, secondaryApp;
        let dbPrimary, dbSecondary;
        
        let userActivityChartInstance, withdrawalStatusChartInstance;
        const ADMIN_AD_EARN_RATE = 0.1; // Updated

        // DOM Elements (Add new ones as needed)
        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminPages = document.querySelectorAll('.admin-page');
        const currentPageTitle = document.getElementById('currentPageTitle');
        const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
        const adminSidebar = document.getElementById('adminSidebar');
        const adminMainContent = document.getElementById('adminMainContent');
        const quizForm = document.getElementById('quizForm');
        const quizFormTitle = document.getElementById('quizFormTitle');
        const editQuizIdInput = document.getElementById('editQuizId');
        const quizQuestionInput = document.getElementById('quizQuestion');
        const quizCoinsInput = document.getElementById('quizCoins');
        const quizOptionsContainer = document.getElementById('quizOptionsContainer');
        const addOptionBtn = document.getElementById('addOptionBtn');
        const cancelEditQuizBtn = document.getElementById('cancelEditQuizBtn');
        const quizzesTableBody = document.querySelector('#quizzesTable tbody');
        const usersTableBody = document.querySelector('#usersTable tbody');
        const userSearchInput = document.getElementById('userSearchInput');
        const recentWithdrawalsTableBody = document.getElementById('recentWithdrawalsTableBody');


        // --- Toast, Sidebar Toggle, Page Navigation (Mostly same as before) ---
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast-notification show';
            if (type === 'success') toast.classList.add('success');
            else if (type === 'error') toast.classList.add('error');
            else if (type === 'warning') toast.classList.add('warning');
            setTimeout(() => { toast.classList.remove('show'); }, duration);
        }

        toggleSidebarBtn.addEventListener('click', () => {
            adminSidebar.classList.toggle('open');
            adminMainContent.classList.toggle('sidebar-open');
        });

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                adminNavLinks.forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');
                adminPages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                currentPageTitle.textContent = link.textContent.trim();
                // Reset quiz form if navigating to "Add New Quiz"
                if (pageId === 'add-quiz' && editQuizIdInput.value) {
                    resetQuizForm();
                }
                // Load data for specific pages
                if (pageId === 'dashboard') loadDashboardData();
                if (pageId === 'manage-quizzes') loadQuizzes();
                if (pageId === 'manage-users') loadUsers();
                if (pageId === 'manage-withdrawals') loadWithdrawals();
                if (pageId === 'reports') loadReportChartsData();
            });
        });
        
        // --- Firebase Helper Functions (Modified for Primary DB) ---
        async function readPrimaryData(path) { try { const snapshot = await dbPrimary.ref(path).once('value'); return snapshot.val(); } catch(e){ console.error(e); showToast('Error reading data (Primary DB)', 'error'); return null; }}
        async function writePrimaryData(path, data) { try { await dbPrimary.ref(path).set(data); } catch(e){ console.error(e); showToast('Error writing data (Primary DB)', 'error');}}
        async function updatePrimaryData(path, data) { try { await dbPrimary.ref(path).update(data); } catch(e){ console.error(e); showToast('Error updating data (Primary DB)', 'error');}}
        async function pushPrimaryData(path, data) { try { const newRef = dbPrimary.ref(path).push(); await newRef.set(data); return newRef.key; } catch(e){ console.error(e); showToast('Error pushing data (Primary DB)', 'error'); return null;}}
        async function removePrimaryData(path) { try { await dbPrimary.ref(path).remove(); } catch(e){ console.error(e); showToast('Error removing data (Primary DB)', 'error');}}

        // --- Helper for Secondary DB (AB Pay) ---
        async function updateSecondaryUserBalance(userId, amountToAdd) {
            if (!dbSecondary) {
                showToast('Secondary DB (AB Pay) not initialized.', 'error');
                return false;
            }
            const userBalanceRef = dbSecondary.ref(`users/${userId}/balance`);
            try {
                const snapshot = await userBalanceRef.once('value');
                let currentBalance = snapshot.val() || 0;
                if (typeof currentBalance !== 'number') currentBalance = 0;
                const newBalance = currentBalance + parseFloat(amountToAdd);
                await userBalanceRef.set(newBalance);
                return true;
            } catch (error) {
                console.error('Error updating balance in Secondary DB:', error);
                showToast(`Failed to update AB Pay balance for ${userId}.`, 'error');
                return false;
            }
        }


        // --- Dashboard Logic ---
        async function loadDashboardData() {
            const usersData = await readPrimaryData('users');
            const withdrawalsData = await readPrimaryData('withdrawals');
            
            let totalUsers = 0, totalAppEarnRough = 0, totalAdsHistorical = 0;
            let userCreationDates = [];

            if (usersData) {
                totalUsers = Object.keys(usersData).length;
                Object.values(usersData).forEach(user => {
                    totalAppEarnRough += (user.balance || 0); // Still a rough estimate
                    totalAdsHistorical += (user.totalAdsWatched || user.adsWatchedToday || 0); // Prioritize historical
                    if(user.createdAt) userCreationDates.push(new Date(user.createdAt).toLocaleDateString()); // Assuming you add 'createdAt'
                });
            }

            let pendingWithdrawals = 0, completedWithdrawals = 0;
            let recentWithdrawalsForTable = [];
            if (withdrawalsData) {
                const sortedWds = Object.values(withdrawalsData)
                                  .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                sortedWds.forEach(wd => {
                    if (wd.status === 'pending') pendingWithdrawals++;
                    if (wd.status === 'completed') completedWithdrawals++;
                    if(recentWithdrawalsForTable.length < 5) recentWithdrawalsForTable.push(wd);
                });
            }

            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('totalAppEarnCount').textContent = `${totalAppEarnRough.toFixed(2)} ৳`;
            document.getElementById('pendingWithdrawalsCount').textContent = pendingWithdrawals;
            document.getElementById('completedWithdrawalsCount').textContent = completedWithdrawals;
            document.getElementById('totalAdsCount').textContent = totalAdsHistorical;
            document.getElementById('adminAdEarningsCount').textContent = (totalAdsHistorical * ADMIN_AD_EARN_RATE).toFixed(2) + ' ৳';

            // Populate Recent Withdrawals Table
            recentWithdrawalsTableBody.innerHTML = '';
            if(recentWithdrawalsForTable.length > 0){
                recentWithdrawalsForTable.forEach(wd => {
                    const row = recentWithdrawalsTableBody.insertRow();
                    row.insertCell().textContent = new Date(wd.timestamp).toLocaleDateString();
                    row.insertCell().textContent = wd.username || wd.userId.slice(0,8)+'...';
                    row.insertCell().textContent = (wd.amount || 0).toFixed(2) + ' ৳';
                    const statusCell = row.insertCell();
                    statusCell.textContent = (wd.status || 'N/A').toUpperCase();
                    statusCell.className = `status-${wd.status || 'unknown'}`;
                });
            } else {
                 recentWithdrawalsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No recent withdrawals.</td></tr>';
            }


            // User Activity Chart (Mock data enhanced)
            const userCtx = document.getElementById('userActivityChart').getContext('2d');
            // Process userCreationDates for a simple count per day (needs more robust date grouping for real app)
            const userCountsByDate = userCreationDates.reduce((acc, date) => {
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});
            const chartLabels = Object.keys(userCountsByDate).sort((a,b) => new Date(a) - new Date(b));
            const chartData = chartLabels.map(label => userCountsByDate[label]);

            if(userActivityChartInstance) userActivityChartInstance.destroy();
            userActivityChartInstance = new Chart(userCtx, {
                type: 'line',
                data: {
                    labels: chartLabels.length > 0 ? chartLabels : ['No Data'],
                    datasets: [{
                        label: 'User Registrations',
                        data: chartData.length > 0 ? chartData : [0],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        tension: 0.1,
                        fill: true,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
            });
        }
        
        // --- Quiz Management (CRUD) ---
        let quizOptionCount = 0;
        function createOptionInput(value = '', isCorrect = false, index) {
            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-input-group';
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.name = 'quizOption';
            textInput.placeholder = `Option ${index + 1}`;
            textInput.value = value;
            textInput.required = true;
            
            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.name = 'correctAnswer';
            radioInput.value = index;
            radioInput.checked = isCorrect;
            radioInput.required = true;
            
            const radioLabel = document.createElement('label');
            radioLabel.htmlFor = `correctAnswer_${index}`; // Needs unique ID for label
            radioLabel.textContent = ' Correct';
            radioInput.id = `correctAnswer_${index}`;


            optionGroup.appendChild(textInput);
            optionGroup.appendChild(radioInput);
            optionGroup.appendChild(radioLabel); // Append label

            if (index > 1) { // Allow removing options beyond the first two
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-option-btn fas fa-times-circle';
                removeBtn.title = 'Remove option';
                removeBtn.onclick = () => optionGroup.remove();
                optionGroup.appendChild(removeBtn);
            }
            quizOptionsContainer.appendChild(optionGroup);
        }

        function resetQuizForm(isEdit = false) {
            quizForm.reset();
            editQuizIdInput.value = '';
            quizOptionsContainer.innerHTML = '';
            quizOptionCount = 0;
            if (!isEdit) { // For new quiz
                createOptionInput('', false, quizOptionCount++);
                createOptionInput('', false, quizOptionCount++);
                quizFormTitle.innerHTML = '<i class="fas fa-feather-alt"></i> Create New Quiz';
                cancelEditQuizBtn.style.display = 'none';
            }
        }
        resetQuizForm(); // Initial setup for "Add New Quiz" page

        addOptionBtn.addEventListener('click', () => {
            createOptionInput('', false, quizOptionCount++);
        });
        
        cancelEditQuizBtn.addEventListener('click', () => {
            resetQuizForm();
            // Optionally navigate back to "Add New Quiz" or clear selection
            document.querySelector('.admin-nav-link[data-page="add-quiz"]').click();
        });

        quizForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const quizId = editQuizIdInput.value;
            const question = quizQuestionInput.value.trim();
            const coins = parseFloat(quizCoinsInput.value);

            if (isNaN(coins) || coins < 0.001 || coins > 100) {
                showToast('Coins must be between 0.001 and 100.', 'warning');
                return;
            }

            const options = [];
            document.querySelectorAll('#quizOptionsContainer input[name="quizOption"]').forEach(optInput => {
                if(optInput.value.trim()) options.push(optInput.value.trim());
            });

            const correctAnswerRadio = document.querySelector('#quizOptionsContainer input[name="correctAnswer"]:checked');
            if (!question || options.length < 2 || !correctAnswerRadio) {
                showToast('Please fill question, at least 2 options, and select a correct answer.', 'warning');
                return;
            }
            const correctAnswerIndex = parseInt(correctAnswerRadio.value);
            // Need to re-map index if options were removed. This simple approach assumes indices are sequential.
            // A more robust way would be to get the text of the selected option's sibling input.
            // For now, this works if options are not reordered drastically during edit.
            const optionElements = Array.from(document.querySelectorAll('#quizOptionsContainer .option-input-group'));
            const selectedOptionGroup = correctAnswerRadio.closest('.option-input-group');
            const actualCorrectIndex = optionElements.indexOf(selectedOptionGroup);
            const correctAnswer = options[actualCorrectIndex];


            const quizData = { question, options, answer: correctAnswer, coins };

            if (quizId) { // Editing existing quiz
                await updatePrimaryData(`quizzes/${quizId}`, quizData);
                showToast('Quiz updated successfully!', 'success');
                document.querySelector('.admin-nav-link[data-page="manage-quizzes"]').click(); // Go to manage page
            } else { // Adding new quiz
                await pushPrimaryData('quizzes', quizData);
                showToast('Quiz added successfully!', 'success');
            }
            resetQuizForm(); // Reset form after save
        });

        async function loadQuizzes() {
            document.getElementById('quizzesLoader').style.display = 'block';
            quizzesTableBody.innerHTML = '';
            const quizzesData = await readPrimaryData('quizzes');
            if (quizzesData) {
                Object.entries(quizzesData).forEach(([id, quiz]) => {
                    const row = quizzesTableBody.insertRow();
                    row.insertCell().textContent = quiz.question.length > 50 ? quiz.question.substring(0, 50) + '...' : quiz.question;
                    row.insertCell().textContent = quiz.coins;
                    row.insertCell().textContent = quiz.options.join(', ').substring(0,40)+'...';
                    row.insertCell().textContent = quiz.answer.length > 30 ? quiz.answer.substring(0,30) + '...' : quiz.answer;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-buttons';
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                    editBtn.className = 'admin-button admin-button-info';
                    editBtn.onclick = () => populateQuizFormForEdit(id, quiz);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                    deleteBtn.className = 'admin-button admin-button-danger';
                    deleteBtn.onclick = () => deleteQuiz(id);
                    actionsCell.appendChild(deleteBtn);
                });
            } else {
                quizzesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No quizzes found.</td></tr>';
            }
            document.getElementById('quizzesLoader').style.display = 'none';
        }

        function populateQuizFormForEdit(quizId, quiz) {
            // Navigate to the add/edit quiz page first
            document.querySelector('.admin-nav-link[data-page="add-quiz"]').click();
            
            resetQuizForm(true); // Reset for edit mode
            quizFormTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Quiz';
            editQuizIdInput.value = quizId;
            quizQuestionInput.value = quiz.question;
            quizCoinsInput.value = quiz.coins;
            
            quiz.options.forEach((option, index) => {
                const isCorrect = (option === quiz.answer);
                // The createOptionInput needs to handle mapping to actual answer, not just index if options are less
                // For simplicity, we assume the index in options array maps to radio value
                // Find correct index for radio button relative to quiz.options:
                let correctRadioValue = quiz.options.indexOf(quiz.answer);

                createOptionInput(option, index === correctRadioValue, index);
                quizOptionCount = index + 1;
            });
            cancelEditQuizBtn.style.display = 'inline-block';
        }

        async function deleteQuiz(quizId) {
            if (confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
                await removePrimaryData(`quizzes/${quizId}`);
                showToast('Quiz deleted successfully!', 'success');
                loadQuizzes(); // Refresh the list
            }
        }

        // --- User Management ---
        let allUsersCache = []; // For client-side search

        async function loadUsers(searchTerm = '') {
            document.getElementById('usersLoader').style.display = 'block';
            usersTableBody.innerHTML = '';
            
            if (allUsersCache.length === 0 || searchTerm) { // Fetch if cache empty or searching
                 const usersData = await readPrimaryData('users');
                 if (usersData) {
                    allUsersCache = Object.entries(usersData).map(([id, data]) => ({ id, ...data }));
                 } else {
                    allUsersCache = [];
                 }
            }

            let filteredUsers = allUsersCache;
            if(searchTerm){
                const lowerSearchTerm = searchTerm.toLowerCase();
                filteredUsers = allUsersCache.filter(user => 
                    user.id.toLowerCase().includes(lowerSearchTerm) ||
                    (user.username && user.username.toLowerCase().includes(lowerSearchTerm)) ||
                    (user.firstName && user.firstName.toLowerCase().includes(lowerSearchTerm))
                );
            }


            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.insertCell().textContent = user.id;
                    row.insertCell().textContent = user.username || 'N/A';
                    row.insertCell().textContent = user.firstName || 'N/A';
                    row.insertCell().textContent = (user.balance || 0).toFixed(2);
                    row.insertCell().textContent = user.quizzesTakenToday || 0;
                    row.insertCell().textContent = user.adsWatchedToday || 0;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-buttons';
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-user-edit"></i> Edit';
                    editBtn.className = 'admin-button admin-button-info';
                    editBtn.onclick = () => openEditUserModal(user.id, user);
                    actionsCell.appendChild(editBtn);
                });
            } else {
                usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No users found${searchTerm ? ' matching your search' : ''}.</td></tr>`;
            }
             document.getElementById('usersLoader').style.display = 'none';
        }
        
        userSearchInput.addEventListener('keyup', (e) => {
            loadUsers(e.target.value);
        });

        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');

        function openEditUserModal(userId, userData) {
            document.getElementById('editingUserId').value = userId;
            document.getElementById('editUserUsername').value = userData.username || '';
            document.getElementById('editUserFirstName').value = userData.firstName || '';
            document.getElementById('editUserBalance').value = (userData.balance || 0).toFixed(2);
            document.getElementById('editUserQuizzesToday').value = userData.quizzesTakenToday || 0;
            document.getElementById('editUserAdsToday').value = userData.adsWatchedToday || 0;
            editUserModal.style.display = 'block';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        window.onclick = function(event) { // Close modal on outside click
            if (event.target == editUserModal) closeModal('editUserModal');
        }

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('editingUserId').value;
            const updatedUserData = {
                username: document.getElementById('editUserUsername').value,
                firstName: document.getElementById('editUserFirstName').value,
                balance: parseFloat(document.getElementById('editUserBalance').value),
                quizzesTakenToday: parseInt(document.getElementById('editUserQuizzesToday').value),
                adsWatchedToday: parseInt(document.getElementById('editUserAdsToday').value)
                // Be careful about overwriting other important fields like lastQuizDate, completedQuizzes, etc.
                // Only update fields intended for admin edit.
            };
            // Basic validation
            if(isNaN(updatedUserData.balance) || isNaN(updatedUserData.quizzesTakenToday) || isNaN(updatedUserData.adsWatchedToday)){
                showToast('Invalid number format in one of the fields.', 'error');
                return;
            }

            await updatePrimaryData(`users/${userId}`, updatedUserData);
            showToast('User details updated successfully!', 'success');
            closeModal('editUserModal');
            allUsersCache = []; // Invalidate cache to refetch
            loadUsers(userSearchInput.value); // Refresh user list
            loadDashboardData(); // Refresh dashboard if balance changed
        });


        // --- Manage Withdrawals Logic (with Two Firebase Instances) ---
        const withdrawalsTableBody = document.querySelector('#manage-withdrawals #withdrawalsTable tbody');
        const withdrawalsLoader = document.querySelector('#manage-withdrawals #withdrawalsLoader');

        async function loadWithdrawals() {
            if(withdrawalsLoader) withdrawalsLoader.style.display = 'block';
            if(withdrawalsTableBody) withdrawalsTableBody.innerHTML = '';
            const withdrawalsData = await readPrimaryData('withdrawals');
            if (withdrawalsData) {
                const sortedWithdrawals = Object.entries(withdrawalsData)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                sortedWithdrawals.forEach(wd => {
                    const row = withdrawalsTableBody.insertRow();
                    row.insertCell().textContent = new Date(wd.timestamp).toLocaleDateString();
                    row.insertCell().textContent = wd.userId;
                    row.insertCell().textContent = wd.username || 'N/A';
                    row.insertCell().textContent = (wd.amount || 0).toFixed(2);
                    
                    const statusCell = row.insertCell();
                    statusCell.textContent = (wd.status || 'pending').toUpperCase();
                    statusCell.className = `status-${wd.status || 'pending'}`;

                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('action-buttons');

                    if (wd.status === 'pending') {
                        const approveBtn = document.createElement('button');
                        approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                        approveBtn.className = 'admin-button admin-button-primary';
                        approveBtn.onclick = () => approveWithdrawal(wd.id, wd.userId, wd.amount);
                        actionsCell.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
                        rejectBtn.className = 'admin-button admin-button-danger';
                        rejectBtn.onclick = () => rejectWithdrawal(wd.id, wd.userId, wd.amount);
                        actionsCell.appendChild(rejectBtn);
                    } else {
                        actionsCell.textContent = '-';
                    }
                });
            } else {
                if(withdrawalsTableBody) withdrawalsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No withdrawal requests.</td></tr>';
            }
            if(withdrawalsLoader) withdrawalsLoader.style.display = 'none';
        }

        async function approveWithdrawal(withdrawalId, userId, amount) {
            if (!confirm(`Approve withdrawal of ${amount} BDT for user ${userId}? This will update AB Pay balance.`)) return;
            
            // 1. Update status in Primary DB
            await updatePrimaryData(`withdrawals/${withdrawalId}`, { status: 'completed' });
            showToast('Withdrawal marked as completed in Quiz App DB!', 'success');

            // 2. Update balance in Secondary DB (AB Pay)
            const abPayUpdateSuccess = await updateSecondaryUserBalance(userId, amount);
            if (abPayUpdateSuccess) {
                showToast(`Successfully updated AB Pay balance for user ${userId} by ${amount} BDT.`, 'success');
            } else {
                showToast(`Withdrawal approved in Quiz DB, but FAILED to update AB Pay balance for user ${userId}. Manual check needed!`, 'error', 7000);
            }
            
            // No need to adjust user's balance in Primary DB here; assuming the Quiz App client handles that.
            // Or, if admin panel should deduct, then:
            // const userPrimary = await readPrimaryData(`users/${userId}`);
            // if(userPrimary) {
            //    const newPrimaryBalance = (userPrimary.balance || 0) - parseFloat(amount);
            //    await updatePrimaryData(`users/${userId}`, { balance: newPrimaryBalance < 0 ? 0 : newPrimaryBalance });
            // }

            loadWithdrawals();
            loadDashboardData();
        }

        async function rejectWithdrawal(withdrawalId, userId, amount) {
            if (!confirm(`Reject withdrawal for user ${userId} and refund ${amount} BDT to their Quiz App balance?`)) return;
            await updatePrimaryData(`withdrawals/${withdrawalId}`, { status: 'rejected' });
            
            const userPrimary = await readPrimaryData(`users/${userId}`);
            if (userPrimary) {
                const newPrimaryBalance = (userPrimary.balance || 0) + parseFloat(amount);
                await updatePrimaryData(`users/${userId}`, { balance: newPrimaryBalance });
                showToast(`Withdrawal rejected. ${amount.toFixed(2)} ৳ refunded to user's Quiz App balance.`, 'warning');
            } else {
                 showToast('Withdrawal rejected, but failed to find user in Quiz App DB to refund.', 'error');
            }
            loadWithdrawals();
            loadDashboardData();
        }
        

        // --- Reports Logic (jsPDF, Chart.js - mostly same as before) ---
        const { jsPDF } = window.jspdf; 
        async function generatePdfReport(title, headers, dataArray, filename) { /* ... same as before ... */ 
            const doc = new jsPDF();
            doc.text(title, 14, 16);
            doc.autoTable({
                startY: 22, head: [headers], body: dataArray,
                theme: 'striped', headStyles: { fillColor: [42, 63, 84] },
            });
            doc.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast(`${filename} PDF generated!`, 'success');
        }
        document.getElementById('downloadUsersPdf').addEventListener('click', async () => { /* ... same ... */ 
            const usersData = await readPrimaryData('users');
            if (!usersData) { showToast('No user data.', 'warning'); return; }
            const headers = ['User ID', 'Username', 'First Name', 'Balance (৳)', 'Quizzes Today', 'Ads Today'];
            const dataArray = Object.values(usersData).map(u => [ u.id, u.username || 'N/A', u.firstName || 'N/A', (u.balance || 0).toFixed(2), u.quizzesTakenToday || 0, u.adsWatchedToday || 0 ]);
            generatePdfReport('User Report', headers, dataArray, 'Users_Report');
        });
        document.getElementById('downloadWithdrawalsPdf').addEventListener('click', async () => { /* ... same ... */ 
            const withdrawalsData = await readPrimaryData('withdrawals');
            if (!withdrawalsData) { showToast('No withdrawal data.', 'warning'); return; }
            const headers = ['Date', 'User ID', 'Username', 'Amount (৳)', 'Status'];
            const dataArray = Object.values(withdrawalsData).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(w => [ new Date(w.timestamp).toLocaleDateString(), w.userId, w.username || 'N/A', (w.amount || 0).toFixed(2), w.status ? w.status.toUpperCase() : 'N/A' ]);
            generatePdfReport('Withdrawals Report', headers, dataArray, 'Withdrawals_Report');
        });
        async function loadReportChartsData() { /* ... same ... */ 
            const withdrawalsData = await readPrimaryData('withdrawals');
            let pending = 0, completed = 0, rejected = 0;
            if (withdrawalsData) {
                Object.values(withdrawalsData).forEach(wd => {
                    if (wd.status === 'pending') pending++;
                    else if (wd.status === 'completed') completed++;
                    else if (wd.status === 'rejected') rejected++;
                });
            }
            const ctxStatus = document.getElementById('withdrawalStatusChart').getContext('2d');
            if (withdrawalStatusChartInstance) withdrawalStatusChartInstance.destroy();
            withdrawalStatusChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Completed', 'Rejected'],
                    datasets: [{ data: [pending, completed, rejected], backgroundColor: ['rgb(255, 159, 64)', 'rgb(75, 192, 192)', 'rgb(255, 99, 132)'], hoverOffset: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }


        // Initialize Firebase Apps and App
        window.onload = () => {
            try {
                if (typeof firebase !== 'undefined' && firebase.initializeApp) {
                    // Initialize Primary Firebase App (Quiz App)
                    primaryApp = firebase.initializeApp(firebaseConfigPrimary, "PRIMARY_APP");
                    dbPrimary = primaryApp.database();
                    console.log("Primary Firebase (Quiz App) Initialized");

                    // Initialize Secondary Firebase App (AB Pay)
                    secondaryApp = firebase.initializeApp(firebaseConfigSecondary, "SECONDARY_APP");
                    dbSecondary = secondaryApp.database();
                    console.log("Secondary Firebase (AB Pay) Initialized");

                    showToast('Admin Panel Pro Initialized!', 'success');
                    loadDashboardData(); // Load initial dashboard
                } else {
                    throw new Error("Firebase SDK base not loaded.");
                }
            } catch (e) {
                console.error("Firebase initialization error:", e);
                showToast(`Critical Error: Firebase Init Failed - ${e.message}`, 'error', 10000);
                document.body.innerHTML = `<h1 style='color:red; text-align:center; margin-top: 50px;'>Critical Error: Firebase failed to initialize. Admin panel cannot operate. Details: ${e.message}</h1>`;
            }
            
            if (window.innerWidth <= 768) {
                adminSidebar.classList.remove('open');
                adminMainContent.classList.remove('sidebar-open');
            } else {
                 adminSidebar.classList.add('open');
                 adminMainContent.classList.add('sidebar-open');
            }
        };
    </script>
    </script>
</body>
</html>
